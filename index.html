<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Place Value: Resource Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700;900&display=swap" rel="stylesheet"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg:#f3f4f6; 
      --ink:#111827;
      --tray:#1f2937; 
      --accent:#3b82f6;
      --block-size: 40px; 
      --block-height: 60px;
      --whole-bg: #e8eef4;
      --whole-text: #334155;
      --whole-border: #cbd5e1;
      --decimal-bg: #fef3ee;
      --decimal-text: #9a3412;
      --decimal-border: #fed7aa;
    }

    body{
      font-family:'Lexend',sans-serif;
      background:var(--bg);
      color:var(--ink);
      height:100vh;
      overflow:hidden;
      touch-action:none;
      user-select: none;
      overscroll-behavior: none;
    }

    #app{position:relative;height:calc(100% - 50px);width:100%; display:flex; flex-direction:column;}

    #dashboard {
      height: 50px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 50;
    }

    .dash-group { display: flex; align-items: center; gap: 12px; }

    #totalDisplay {
      font-size: 20px;
      font-weight: 900;
      color: #374151;
      background: #f3f4f6;
      padding: 4px 16px;
      border-radius: 25px;
      min-width: 80px;
      text-align: center;
      border: 2px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    #totalDisplay:hover {
      border-color: var(--accent);
    }
    #totalDisplay.editing {
      display: none;
    }
    
    #numberInputWrapper {
      display: none;
      align-items: center;
      gap: 8px;
    }
    #numberInputWrapper.active {
      display: flex;
    }
    
    #numberInput {
      font-size: 20px;
      font-weight: 900;
      color: #374151;
      background: white;
      padding: 4px 12px;
      border-radius: 25px;
      min-width: 80px;
      text-align: center;
      border: 2px solid var(--accent);
      font-family: inherit;
      outline: none;
      width: 140px;
    }
    
    #inputConfirm {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #inputCancel {
      background: #6b7280;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn {
      border: none;
      background: #374151;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s, background 0.2s;
      font-size: 13px;
    }
    .btn:hover { background: #1f2937; transform: translateY(-1px); }
    .btn:active { transform: translateY(1px); }
    .btn-icon { font-size: 18px; }
    .btn-primary { background: var(--accent); }
    .btn-primary:hover { background: #2563eb; }
    .btn-danger { background: #ef4444; }
    .btn-danger:hover { background: #dc2626; }

    #numberLinePanel {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 20px 5px;
      z-index: 45;
    }
    
    .zoom-bar-container { margin-bottom: 8px; }
    
    .zoom-bar {
      position: relative;
      height: 8px;
      background: linear-gradient(to right, #3498db, #9b59b6, #e74c3c);
      border-radius: 4px;
      margin-bottom: 5px;
    }
    
    .zoom-indicator {
      position: absolute;
      top: -4px;
      width: 4px;
      height: 16px;
      background: #2c3e50;
      border-radius: 2px;
      transition: left 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .zoom-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.65rem;
      color: #9ca3af;
    }
    
    .number-line-container {
      position: relative;
      height: 65px; 
      cursor: ns-resize;
      overflow: visible; 
      margin: 5px 50px 0 50px;
    }
    
    .number-line {
      width: 100%;
      height: 40px;
      position: relative;
      background: linear-gradient(to bottom, transparent 46%, #2c3e50 46%, #2c3e50 54%, transparent 54%);
    }
    
    .tick {
      position: absolute;
      top: 25%;
      width: 2px;
      height: 50%;
      background: #d1d5db;
      transform: translateX(-50%);
    }
    
    .tick.major {
      top: 15%;
      width: 2px;
      height: 70%;
      background: #6b7280;
    }
    
    .tick-label {
      position: absolute;
      top: 42px; 
      transform: translateX(-50%);
      font-weight: 600;
      font-size: 0.7rem;
      color: #6b7280;
      white-space: nowrap;
    }
    
    .value-dot {
      position: absolute;
      width: 16px;
      height: 16px;
      background: #e74c3c;
      border: 2px solid white;
      border-radius: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .dot-label {
      position: absolute;
      top: -24px;
      left: 50%;
      transform: translateX(-50%);
      background: #e74c3c;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 700;
      font-size: 0.7rem;
      white-space: nowrap;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .dot-label::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 4px solid #e74c3c;
    }
    
    .zoom-hint {
      display: none;
    }

    #workPane{
      flex: 1;
      position:relative;
      background:radial-gradient(circle at center, #ffffff 0%, #f3f4f6 100%);
      overflow:hidden;
    }
    
    #snapLine{
      position:absolute;
      top:50%;
      left:0; right:0;
      height:2px;
      background:rgba(0,0,0,0.04);
      pointer-events:none;
      z-index:5;
    }
    #snapLine .decimal-point {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 14px;
      height: 14px;
      background: #475569;
      border-radius: 50%;
      margin-top: 35px;
    }

    #bottomDock{
      height: 22vh;
      min-height: 140px;
      background: var(--tray);
      display: flex; flex-direction: column;
      z-index: 60;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    }

    #drawerTabs{
      display:flex;
      background:#374151;
      overflow-x:auto;
      padding: 0 10px;
      scrollbar-width: none;
    }
    #drawerTabs::-webkit-scrollbar { display: none; }

    .drawer-tab{
      padding:8px 14px;
      background:transparent; color: #9ca3af;
      border:none; cursor:pointer;
      font-weight:700; font-size:11px;
      white-space:nowrap; transition:all .2s;
      border-bottom: 3px solid transparent;
    }
    .drawer-tab.active{
      color: white; background: rgba(255,255,255,0.1);
      border-bottom: 3px solid var(--accent);
    }

    #baseTiles{
      flex:1;
      padding:10px 15px;
      overflow-x: auto; overflow-y: hidden;
      display:flex; align-items:center;
    }
    .base-row{ display:flex; gap:10px; margin: 0 auto; }

    .tile{
      height:var(--block-height);
      display:flex;
      cursor:grab;
      border-radius:12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      background: var(--whole-bg);
      border: 2px solid var(--whole-border);
      overflow:hidden;
      transition: transform 0.1s, box-shadow 0.1s;
      touch-action: none; 
    }
    .tile:active{ cursor:grabbing; }
    .work-pane-tile{ position:absolute; transition: left 0.2s, top 0.2s; }

    .digit-block{
      width:var(--block-size); height:var(--block-height);
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:28px; line-height:1;
      color: var(--whole-text);
      flex-shrink: 0; 
    }
    .comma-block{ width:14px; align-items:flex-end; padding-bottom:10px; flex-shrink: 0; }
    .decimal-block{ width:14px; font-size:28px; font-weight:700; align-items:flex-end; padding-bottom:8px; flex-shrink: 0; }

    .tile.decimal-tile {
      background: var(--decimal-bg);
      border-color: var(--decimal-border);
    }
    .tile.decimal-tile .digit-block {
      color: var(--decimal-text);
    }
    
    .drag-ghost {
      position: fixed;
      z-index: 10000;
      pointer-events: none;
      opacity: 0.7;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
      cursor: grabbing;
      transform-origin: center center;
    }
    
    .plus-sign {
      position: absolute;
      font-size: 28px;
      font-weight: 700;
      color: #9ca3af;
      pointer-events: none;
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: var(--block-height);
    }
    
    .tile.sliding {
      transition: left 0.5s ease-in-out, background 0.5s ease-in-out, border-color 0.5s ease-in-out;
    }
    .tile.sliding .digit-block {
      transition: color 0.5s ease-in-out;
    }
    
    #messagePopup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1f2937;
      color: white;
      padding: 20px 30px;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      z-index: 10000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      max-width: 400px;
    }
    #messagePopup.show {
      opacity: 1;
    }
    #messagePopup .emoji {
      font-size: 36px;
      display: block;
      margin-bottom: 10px;
    }

    /* ============================================ */
    /* QUIZ MODE STYLES - ADDED FOR IEP GOAL       */
    /* ============================================ */
    #quizOverlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: var(--bg);
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
      overflow-y: auto;
    }
    #quizOverlay.active {
      display: flex;
    }

    .quiz-header {
      width: 100%;
      max-width: 600px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .quiz-title {
      font-size: 22px;
      font-weight: 900;
      color: var(--ink);
      letter-spacing: -0.5px;
    }
    .quiz-close {
      background: #e5e7eb;
      border: 1px solid #d1d5db;
      color: #6b7280;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .quiz-close:hover {
      background: #d1d5db;
      color: var(--ink);
    }

    .quiz-progress-bar {
      width: 100%;
      max-width: 600px;
      height: 10px;
      background: #e5e7eb;
      border-radius: 5px;
      margin-bottom: 12px;
      overflow: hidden;
    }
    .quiz-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #8b5cf6);
      border-radius: 5px;
      transition: width 0.4s ease;
      width: 0%;
    }
    
    .quiz-score {
      width: 100%;
      max-width: 600px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      font-size: 14px;
      color: #6b7280;
      font-weight: 700;
    }
    .quiz-score-right {
      color: #059669;
    }
    
    .quiz-card {
      width: 100%;
      max-width: 600px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 20px;
      padding: 28px 24px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }

    .quiz-prompt {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 20px;
      font-weight: 700;
    }

    .quiz-number-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      margin-bottom: 28px;
      flex-wrap: wrap;
    }
    .quiz-digit {
      font-size: 52px;
      font-weight: 900;
      color: var(--ink);
      width: 48px;
      height: 72px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      transition: all 0.3s;
      position: relative;
    }
    .quiz-digit.separator {
      width: 24px;
      color: #9ca3af;
      font-size: 48px;
    }
    .quiz-digit.highlighted {
      background: var(--accent);
      color: white;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
      animation: quiz-pulse 1.5s ease-in-out infinite;
    }
    @keyframes quiz-pulse {
      0%, 100% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
      50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.5); }
    }

    .quiz-digit-label {
      position: absolute;
      bottom: -22px;
      font-size: 9px;
      font-weight: 700;
      color: #9ca3af;
      white-space: nowrap;
    }
    .quiz-digit.highlighted .quiz-digit-label {
      color: var(--accent);
    }

    .quiz-choices {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-width: 440px;
      margin: 0 auto;
      justify-content: center;
    }
    .quiz-choice {
      background: var(--whole-bg);
      border: 2px solid var(--whole-border);
      color: var(--whole-text);
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 90px;
      text-align: center;
    }
    .quiz-choice:hover {
      background: #dbe4ed;
      border-color: #94a3b8;
      transform: translateY(-2px);
    }
    .quiz-choice:active {
      transform: translateY(1px);
    }
    .quiz-choice.correct {
      background: #d1fae5;
      border-color: #059669;
      color: #059669;
      animation: quiz-correct 0.4s ease;
    }
    .quiz-choice.wrong {
      background: #fee2e2;
      border-color: #ef4444;
      color: #ef4444;
      animation: quiz-shake 0.4s ease;
    }
    @keyframes quiz-correct {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    @keyframes quiz-shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }

    .quiz-feedback {
      margin-top: 20px;
      font-size: 18px;
      font-weight: 900;
      min-height: 30px;
      transition: opacity 0.3s;
    }
    .quiz-feedback.correct-fb { color: #059669; }
    .quiz-feedback.wrong-fb { color: #ef4444; }

    .quiz-expand-btn {
      background: var(--whole-bg);
      border: 2px solid var(--whole-border);
      color: #6b7280;
      padding: 8px 18px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .quiz-expand-btn:hover {
      background: #dbe4ed;
      border-color: #94a3b8;
    }
    
    .quiz-expanded-form {
      margin-top: 14px;
      padding: 14px 20px;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      animation: quiz-expand-in 0.4s ease;
    }
    @keyframes quiz-expand-in {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .quiz-expanded-part {
      font-size: 28px;
      font-weight: 900;
      color: var(--whole-text);
      padding: 4px 10px;
      border-radius: 8px;
    }
    .quiz-expanded-part.is-answer {
      background: #dbeafe;
      color: var(--accent);
      border: 2px solid #93c5fd;
    }
    .quiz-expanded-plus {
      font-size: 22px;
      font-weight: 700;
      color: #9ca3af;
    }

    .quiz-next-btn {
      margin-top: 16px;
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 32px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      animation: quiz-expand-in 0.3s ease;
    }
    .quiz-next-btn:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }

    .quiz-digit.tappable {
      cursor: pointer;
      transition: all 0.2s;
    }
    .quiz-digit.tappable:hover {
      background: #dbeafe;
      transform: scale(1.08);
    }
    .quiz-digit.tappable:active {
      transform: scale(0.97);
    }
    
    .quiz-tap-prompt {
      font-size: 15px;
      color: #6b7280;
      font-weight: 700;
      margin-bottom: 16px;
    }
    
    .quiz-new-number-row {
      margin-top: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .quiz-new-number-input {
      font-family: inherit;
      font-size: 16px;
      font-weight: 700;
      padding: 8px 14px;
      border-radius: 10px;
      border: 2px solid #d1d5db;
      width: 140px;
      color: var(--ink);
      background: white;
      outline: none;
      text-align: center;
      transition: border-color 0.2s;
    }
    .quiz-new-number-input:focus {
      border-color: var(--accent);
    }
    .quiz-new-number-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 18px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .quiz-new-number-btn:hover {
      background: #2563eb;
    }

    /* Results screen */
    .quiz-results {
      text-align: center;
      padding: 20px;
    }
    .quiz-results-emoji {
      font-size: 64px;
      margin-bottom: 16px;
    }
    .quiz-results-score {
      font-size: 48px;
      font-weight: 900;
      color: var(--ink);
      margin-bottom: 8px;
    }
    .quiz-results-label {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 24px;
      font-weight: 700;
    }
    .quiz-results-message {
      font-size: 18px;
      color: var(--whole-text);
      margin-bottom: 28px;
      line-height: 1.5;
    }
    .quiz-results-btns {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .quiz-results-btn {
      padding: 12px 28px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .quiz-results-btn:hover { transform: translateY(-2px); }
    .quiz-results-btn.primary {
      background: var(--accent);
      color: white;
    }
    .quiz-results-btn.secondary {
      background: var(--whole-bg);
      color: var(--whole-text);
      border: 2px solid var(--whole-border);
    }

    .quiz-settings {
      width: 100%;
      max-width: 600px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .quiz-settings-label {
      font-size: 13px;
      color: #6b7280;
      font-weight: 700;
      margin-right: 4px;
    }
    .quiz-range-btn {
      background: white;
      border: 2px solid #d1d5db;
      color: #6b7280;
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .quiz-range-btn:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }
    .quiz-range-btn.active {
      background: #dbeafe;
      border-color: var(--accent);
      color: var(--accent);
    }
    #quizDataOverlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10001;
      background: rgba(0,0,0,0.4);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    #quizDataOverlay.active {
      display: flex;
    }
    .quiz-data-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      color: var(--ink);
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }
    .quiz-data-card h3 {
      font-size: 18px;
      margin-bottom: 16px;
      color: var(--ink);
    }
    .quiz-data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .quiz-data-table th,
    .quiz-data-table td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    .quiz-data-table th {
      color: #6b7280;
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .quiz-data-table .correct-row { color: #059669; }
    .quiz-data-table .wrong-row { color: #ef4444; }
    .quiz-data-close {
      margin-top: 16px;
      width: 100%;
      padding: 10px;
      background: var(--whole-bg);
      color: var(--whole-text);
      border: 2px solid var(--whole-border);
      border-radius: 8px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      font-size: 14px;
    }
    .quiz-data-copy {
      margin-top: 8px;
      width: 100%;
      padding: 10px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <div id="dashboard">
    <div class="dash-group">
      <button class="btn btn-danger" id="resetBtn"><span class="btn-icon">üóë</span> Clear</button>
      <div id="totalDisplay" title="Click to enter a number">
        <span id="sumText">0</span>
        <button class="btn btn-primary" id="speakBtn" style="padding:4px 8px; border-radius:20px; min-width:auto;" title="Read Aloud">üîä</button>
      </div>
      <div id="numberInputWrapper">
        <input type="text" id="numberInput" placeholder="Enter number..." />
        <button id="inputConfirm" title="Confirm">‚úì</button>
        <button id="inputCancel" title="Cancel">‚úï</button>
      </div>
    </div>
    <div class="dash-group">
      <button class="btn" id="divideBtn"><span class="btn-icon">‚ûó</span> √∑10</button>
      <button class="btn" id="multiplyBtn"><span class="btn-icon">‚úñÔ∏è</span> √ó10</button>
      <button class="btn" id="expandBtn"><span class="btn-icon">üí•</span> Expand</button>
      <button class="btn btn-primary" id="quizBtn"><span class="btn-icon">üéØ</span> Quiz</button>
    </div>
  </div>

  <div id="messagePopup"><span class="emoji"></span><span class="text"></span></div>

  <!-- QUIZ OVERLAY -->
  <div id="quizOverlay">
    <div class="quiz-header">
      <div class="quiz-title">Place Value Quiz</div>
      <button class="quiz-close" id="quizCloseBtn">‚úï</button>
    </div>
    <div class="quiz-progress-bar"><div class="quiz-progress-fill" id="quizProgressFill"></div></div>
    <div class="quiz-settings" id="quizSettings">
      <span class="quiz-settings-label">Up to:</span>
      <button class="quiz-range-btn active" data-digits="3">100s</button>
      <button class="quiz-range-btn" data-digits="4">1,000s</button>
      <button class="quiz-range-btn" data-digits="5">10,000s</button>
      <button class="quiz-range-btn" data-digits="6">100,000s</button>
      <span style="color:#d1d5db;margin:0 4px;">‚îÇ</span>
      <span class="quiz-settings-label">or</span>
      <input type="text" id="quizCustomInput" placeholder="Type a number" style="
        font-family:inherit; font-size:14px; font-weight:700;
        padding:6px 12px; border-radius:8px; border:2px solid #d1d5db;
        width:120px; color:var(--ink); background:white; outline:none;
        transition: border-color 0.2s;
      " />
      <button class="quiz-range-btn" id="quizCustomBtn" style="background:var(--accent);color:white;border-color:var(--accent);">Go</button>
    </div>
    <div class="quiz-score">
      <span id="quizQuestionNum">Question 1 of 10</span>
      <span class="quiz-score-right" id="quizScoreDisplay">0 correct</span>
    </div>
    <div class="quiz-card" id="quizCard">
      <!-- Quiz content injected here -->
    </div>
  </div>

  <!-- DATA LOG OVERLAY -->
  <div id="quizDataOverlay">
    <div class="quiz-data-card" id="quizDataCard">
      <!-- Data table injected here -->
    </div>
  </div>

  <div id="app">
    <div id="numberLinePanel">
      <div class="zoom-bar-container">
        <div class="zoom-bar">
          <div class="zoom-indicator" id="zoomIndicator"></div>
        </div>
        <div class="zoom-labels">
          <span>0.001</span><span>0.01</span><span>0.1</span><span>1</span><span>10</span>
          <span>100</span><span>1K</span><span>10K</span><span>100K</span><span>1M</span>
        </div>
      </div>
      <div class="number-line-container" id="numberLineContainer">
        <div class="number-line" id="numberLine"></div>
      </div>
      <div class="zoom-hint">Ctrl+scroll or pinch to zoom</div>
    </div>

    <div id="workPane">
      <div id="snapLine"><div class="decimal-point"></div></div>
    </div>

    <div id="bottomDock">
      <div id="drawerTabs">
        <button class="drawer-tab" data-drawer="millions">Millions</button>
        <button class="drawer-tab" data-drawer="hundredThousands">H. Thousands</button>
        <button class="drawer-tab" data-drawer="tenThousands">T. Thousands</button>
        <button class="drawer-tab" data-drawer="thousands">Thousands</button>
        <button class="drawer-tab" data-drawer="hundreds">Hundreds</button>
        <button class="drawer-tab" data-drawer="tens">Tens</button>
        <button class="drawer-tab active" data-drawer="ones">Ones</button>
        <button class="drawer-tab" data-drawer="tenths">Tenths</button>
        <button class="drawer-tab" data-drawer="hundredths">Hundredths</button>
        <button class="drawer-tab" data-drawer="thousandths">Thousandths</button>
      </div>
      <div id="baseTiles">
        <div class="base-row" id="baseRow"></div>
      </div>
    </div>
  </div>

  <script>
    const BLOCK_SIZE = 40;
    const BLOCK_HEIGHT = 60;
    
    const PLACE_VALUES = {
      tenths: [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9],
      hundredths: [0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09],
      thousandths: [0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007, 0.008, 0.009],
      ones: [1, 2, 3, 4, 5, 6, 7, 8, 9],
      tens: [10, 20, 30, 40, 50, 60, 70, 80, 90],
      hundreds: [100, 200, 300, 400, 500, 600, 700, 800, 900],
      thousands: [1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000],
      tenThousands: [10000, 20000, 30000, 40000, 50000, 60000, 70000, 80000, 90000],
      hundredThousands: [100000, 200000, 300000, 400000, 500000, 600000, 700000, 800000, 900000],
      millions: [1000000, 2000000, 3000000, 4000000, 5000000, 6000000, 7000000, 8000000, 9000000]
    };

    const ZOOM_LEVELS = [
      { name: 'Thousandths', step: 0.001, decimals: 4 },
      { name: 'Hundredths', step: 0.01, decimals: 3 },
      { name: 'Tenths', step: 0.1, decimals: 2 },
      { name: 'Ones', step: 1, decimals: 1 },
      { name: 'Tens', step: 10, decimals: 0 },
      { name: 'Hundreds', step: 100, decimals: 0 },
      { name: 'Thousands', step: 1000, decimals: 0 },
      { name: 'Ten Thousands', step: 10000, decimals: 0 },
      { name: 'Hundred Thousands', step: 100000, decimals: 0 },
      { name: 'Millions', step: 1000000, decimals: 0 }
    ];

    let tiles = []; 
    let activeDrawer = 'ones'; 
    let currentTotal = 0;
    let currentZoomIndex = 3;
    let isExpanded = false;
    let currentViewCenter = 0;
    let targetViewCenter = 0;
    let isAnimatingView = false;
    
    let isDragging = false;
    let dragData = null;
    let dragGhost = null;
    let dragOffset = { x: 0, y: 0 };
    let lastTouchDistance = null;

    // ====== NUMBER LINE ======
    function formatNumberLineLabel(value, decimals) {
      if (decimals <= 1) {
        return Math.abs(value) >= 1000 ? Math.round(value).toLocaleString() : Math.round(value).toString();
      }
      return value.toFixed(decimals - 1);
    }

    function startViewAnimation() {
      if (isAnimatingView) return;
      isAnimatingView = true;
      requestAnimationFrame(animateViewStep);
    }

    function animateViewStep() {
      const diff = targetViewCenter - currentViewCenter;
      if (Math.abs(diff) < 0.0001) {
        currentViewCenter = targetViewCenter;
        renderNumberLine();
        isAnimatingView = false;
        return;
      }
      currentViewCenter += diff * 0.05;
      renderNumberLine();
      if (isAnimatingView) requestAnimationFrame(animateViewStep);
    }

    function renderNumberLine() {
      const numberLine = document.getElementById('numberLine');
      const zoomIndicator = document.getElementById('zoomIndicator');
      numberLine.innerHTML = '';
      
      const zoom = ZOOM_LEVELS[currentZoomIndex];
      const step = zoom.step;
      const decimals = zoom.decimals;
      const visibleRange = step * 10; 
      
      zoomIndicator.style.left = `calc(${(currentZoomIndex / (ZOOM_LEVELS.length - 1)) * 100}% - 2px)`;
      
      let min = currentViewCenter - (visibleRange / 2);
      let max = currentViewCenter + (visibleRange / 2);
      if (min < 0) { min = 0; max = visibleRange; }
      
      const dotPosition = ((currentTotal - min) / (max - min)) * 100;
      const firstMajor = Math.floor(min / step) * step;
      
      for (let v = firstMajor; v <= max + step; v += step) {
        const val = parseFloat(v.toFixed(4));
        if (val < min || val > max) continue;
        
        const posPercent = ((val - min) / (max - min)) * 100;
        const tick = document.createElement('div');
        tick.className = 'tick';
        if (Math.round(val / step) % 5 === 0) tick.classList.add('major');
        tick.style.left = posPercent + '%';
        numberLine.appendChild(tick);
        
        const label = document.createElement('div');
        label.className = 'tick-label';
        label.style.left = posPercent + '%';
        label.textContent = formatNumberLineLabel(val, decimals);
        numberLine.appendChild(label);
      }
      
      if (dotPosition >= -5 && dotPosition <= 105) {
        const valueDot = document.createElement('div');
        valueDot.className = 'value-dot';
        valueDot.style.left = dotPosition + '%';
        const dotLabel = document.createElement('div');
        dotLabel.className = 'dot-label';
        dotLabel.textContent = currentTotal.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 3 });
        valueDot.appendChild(dotLabel);
        numberLine.appendChild(valueDot);
      }
    }

    function updateNumberLineTarget() {
      const zoom = ZOOM_LEVELS[currentZoomIndex];
      const visibleRange = zoom.step * 10;
      const threshold = visibleRange * 0.35;
      
      if (Math.abs(currentTotal - targetViewCenter) > threshold) {
        targetViewCenter = Math.max(currentTotal, visibleRange / 2);
        startViewAnimation();
      } else if (!isAnimatingView) {
        renderNumberLine();
      }
    }

    function snapNumberLine() {
      const visibleRange = ZOOM_LEVELS[currentZoomIndex].step * 10;
      targetViewCenter = currentViewCenter = Math.max(currentTotal, visibleRange / 2);
      isAnimatingView = false;
      renderNumberLine();
    }

    const numberLineContainer = document.getElementById('numberLineContainer');
    numberLineContainer.addEventListener('wheel', (e) => {
      if (e.ctrlKey) {
        e.preventDefault();
        if (e.deltaY < 0 && currentZoomIndex < ZOOM_LEVELS.length - 1) currentZoomIndex++;
        else if (e.deltaY > 0 && currentZoomIndex > 0) currentZoomIndex--;
        snapNumberLine();
      }
    });
    
    numberLineContainer.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2) lastTouchDistance = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
    });
    numberLineContainer.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2 && lastTouchDistance) {
        e.preventDefault();
        const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        if (Math.abs(dist - lastTouchDistance) > 15) {
          if (dist > lastTouchDistance && currentZoomIndex < ZOOM_LEVELS.length - 1) currentZoomIndex++;
          else if (dist < lastTouchDistance && currentZoomIndex > 0) currentZoomIndex--;
          snapNumberLine();
          lastTouchDistance = dist;
        }
      }
    });
    numberLineContainer.addEventListener('touchend', () => { lastTouchDistance = null; });

    // ====== HELPERS ======
    function getPlaceValueType(value) {
      if (value < 0.01) return 'thousandths';
      if (value < 0.1) return 'hundredths';
      if (value < 1) return 'tenths';
      if (value < 10) return 'ones';
      if (value < 100) return 'tens';
      if (value < 1000) return 'hundreds';
      if (value < 10000) return 'thousands';
      if (value < 100000) return 'tenThousands';
      if (value < 1000000) return 'hundredThousands';
      return 'millions';
    }

    function isDecimalValue(value) { return value < 1; }

    function getDigitsArray(value, showFullDecimal = false) {
      let str;
      if (value < 1) {
        str = value < 0.01 ? value.toFixed(3) : value < 0.1 ? value.toFixed(2) : value.toFixed(1);
        return showFullDecimal ? str.split('') : str.split('.')[1].split('');
      }
      str = String(Math.floor(value));
      const result = [];
      for (let i = 0; i < str.length; i++) {
        result.push(str[i]);
        const posFromRight = str.length - i - 1;
        if (posFromRight > 0 && posFromRight % 3 === 0) result.push(',');
      }
      return result;
    }

    function getPlaceValueOrder(placeValue) {
      return { thousandths: 100, hundredths: 101, tenths: 102, millions: 103, hundredThousands: 104, tenThousands: 105, thousands: 106, hundreds: 107, tens: 108, ones: 109 }[placeValue];
    }

    function getSnapLinePosition(placeValue) {
      const workPane = document.getElementById('workPane');
      const paneRect = workPane.getBoundingClientRect();
      const decimalPoint = document.querySelector('#snapLine .decimal-point');
      const pointRect = decimalPoint.getBoundingClientRect();
      
      const snapY = (paneRect.height / 2) - (BLOCK_HEIGHT / 2);
      const centerX = pointRect.left - paneRect.left + (pointRect.width / 2);
      const DECIMAL_SPACING = 8;
      const EXPAND_GAP = 30;
      const scale = getScaleFactor();
      const scaledBlockSize = BLOCK_SIZE * scale;
      
      const decimalPlaces = ['tenths', 'hundredths', 'thousandths'];
      const wholePlaces = ['ones', 'tens', 'hundreds', 'thousands', 'tenThousands', 'hundredThousands', 'millions'];
      const snappedTiles = tiles.filter(t => t.snappedToLine);
      
      if (decimalPlaces.includes(placeValue)) {
        const position = decimalPlaces.indexOf(placeValue);
        if (isExpanded) {
          let offsetX = DECIMAL_SPACING;
          for (let i = 0; i < position; i++) {
            if (snappedTiles.some(t => t.placeValue === decimalPlaces[i])) {
              offsetX += getExpandedCardWidthForPlaceValue(decimalPlaces[i]) * scale + EXPAND_GAP;
            }
          }
          return { x: centerX + offsetX, y: snapY };
        } else {
          const rightEdgeX = centerX + DECIMAL_SPACING + ((position + 1) * scaledBlockSize);
          return { x: rightEdgeX - getCardWidthForSnapped(placeValue, scale), y: snapY };
        }
      } else {
        const position = wholePlaces.indexOf(placeValue);
        if (isExpanded) {
          let offsetX = DECIMAL_SPACING + getExpandedCardWidthForPlaceValue(placeValue) * scale;
          for (let i = 0; i < position; i++) {
            if (snappedTiles.some(t => t.placeValue === wholePlaces[i])) {
              offsetX += getExpandedCardWidthForPlaceValue(wholePlaces[i]) * scale + EXPAND_GAP;
            }
          }
          return { x: centerX - offsetX, y: snapY };
        } else {
          return { x: centerX - DECIMAL_SPACING - getCardWidthForSnapped(placeValue, scale), y: snapY };
        }
      }
    }
    
    function getExpandedCardWidthForPlaceValue(placeValue) {
      const values = { tenths: 0.1, hundredths: 0.01, thousandths: 0.001, ones: 1, tens: 10, hundreds: 100, thousands: 1000, tenThousands: 10000, hundredThousands: 100000, millions: 1000000 };
      return getExpandedCardWidth(values[placeValue] || 1);
    }
    
    function getCardWidthForSnapped(placeValue, scale = 1) {
      const decimalDigits = { tenths: 1, hundredths: 2, thousandths: 3 };
      const wholeDigits = { ones: 1, tens: 2, hundreds: 3, thousands: 5, tenThousands: 6, hundredThousands: 7, millions: 9 };
      if (decimalDigits[placeValue]) return decimalDigits[placeValue] * BLOCK_SIZE * scale;
      if (wholeDigits[placeValue]) {
        const commas = placeValue === 'thousands' ? 1 : ['tenThousands', 'hundredThousands'].includes(placeValue) ? 1 : placeValue === 'millions' ? 2 : 0;
        return ((wholeDigits[placeValue] - commas) * BLOCK_SIZE + commas * 14) * scale;
      }
      return BLOCK_SIZE * scale;
    }
    
    function getScaleFactor() {
      const workPane = document.getElementById('workPane');
      if (!workPane) return 1;
      const paneWidth = workPane.getBoundingClientRect().width;
      const snappedTiles = tiles.filter(t => t.snappedToLine);
      if (snappedTiles.length === 0) return 1;
      
      let totalWidth = 50;
      if (isExpanded) {
        const EXPAND_GAP = 30;
        snappedTiles.forEach((t, i) => {
          totalWidth += getExpandedCardWidthForPlaceValue(t.placeValue);
          if (i < snappedTiles.length - 1) totalWidth += EXPAND_GAP;
        });
      } else {
        const decimalPlaces = ['tenths', 'hundredths', 'thousandths'];
        let wholeSlots = 0, decimalSlots = 0;
        snappedTiles.forEach(t => {
          if (decimalPlaces.includes(t.placeValue)) decimalSlots = Math.max(decimalSlots, decimalPlaces.indexOf(t.placeValue) + 1);
          else wholeSlots = Math.max(wholeSlots, ['ones', 'tens', 'hundreds', 'thousands', 'tenThousands', 'hundredThousands', 'millions'].indexOf(t.placeValue) + 1);
        });
        totalWidth = (wholeSlots + decimalSlots) * BLOCK_SIZE + 50;
      }
      const scale = totalWidth > paneWidth * 0.9 ? (paneWidth * 0.9) / totalWidth : 1;
      return Math.max(0.4, scale);
    }
    
    function getExpandedCardWidth(value) {
      return getDigitsArray(value, true).reduce((w, c) => w + (c === ',' || c === '.' ? 14 : BLOCK_SIZE), 0);
    }

    // ====== CREATE TILE ELEMENT ======
    function createTileElement(value, showFullDecimal) {
      const el = document.createElement('div');
      const isDecimal = isDecimalValue(value);
      const digits = getDigitsArray(value, showFullDecimal);
      el.className = `tile${isDecimal ? ' decimal-tile' : ''}`;
      digits.forEach(char => {
        const d = document.createElement('div');
        d.className = char === ',' ? 'digit-block comma-block' : char === '.' ? 'digit-block decimal-block' : 'digit-block';
        d.textContent = char;
        el.appendChild(d);
      });
      return el;
    }

    // ====== RENDER ======
    function renderActiveDrawer() {
      const baseRow = document.getElementById('baseRow');
      baseRow.innerHTML = '';
      (PLACE_VALUES[activeDrawer] || []).forEach(val => {
        const tile = createTileElement(val, isDecimalValue(val));
        tile.dataset.value = val;
        tile.addEventListener('pointerdown', (e) => startDrag(e, val, 'tray'));
        baseRow.appendChild(tile);
      });
    }

    function renderWorkPane(animate = false) {
      const workPane = document.getElementById('workPane');
      workPane.querySelectorAll('.work-pane-tile, .plus-sign').forEach(el => el.remove());
      
      let sum = 0;
      const scale = getScaleFactor();
      
      tiles.forEach(tile => {
        if (tile.snappedToLine) {
          const pos = getSnapLinePosition(tile.placeValue);
          tile.x = pos.x;
          tile.y = pos.y;
        }
      });
      
      const sortedTiles = [...tiles].sort((a, b) => a.zIndex - b.zIndex);
      const snappedTiles = sortedTiles.filter(t => t.snappedToLine);

      sortedTiles.forEach(tile => {
        sum += tile.value;
        const isDecimal = isDecimalValue(tile.value);
        const showFull = !tile.snappedToLine || isExpanded;
        const digits = getDigitsArray(tile.value, isDecimal && showFull);

        const el = document.createElement('div');
        el.className = `tile work-pane-tile${isDecimal ? ' decimal-tile' : ''}`;
        if (animate) el.classList.add('sliding');
        el.style.cssText = `left:${tile.x}px;top:${tile.y}px;z-index:${tile.zIndex}`;
        if (tile.snappedToLine && scale < 1) {
          el.style.transform = `scale(${scale})`;
          el.style.transformOrigin = isDecimal ? 'left center' : 'right center';
        }
        digits.forEach(char => {
          const d = document.createElement('div');
          d.className = char === ',' ? 'digit-block comma-block' : char === '.' ? 'digit-block decimal-block' : 'digit-block';
          d.textContent = char;
          el.appendChild(d);
        });
        el.addEventListener('pointerdown', (e) => startDrag(e, tile.value, tile.id));
        workPane.appendChild(el);
      });
      
      if (isExpanded && snappedTiles.length > 1) {
        const paneHeight = workPane.getBoundingClientRect().height;
        const plusY = (paneHeight / 2) - (BLOCK_HEIGHT * scale / 2);
        const decimalPoint = document.querySelector('#snapLine .decimal-point');
        const pointRect = decimalPoint.getBoundingClientRect();
        const paneRect = workPane.getBoundingClientRect();
        const decimalCenterX = pointRect.left - paneRect.left + (pointRect.width / 2);
        const EXPAND_GAP = 30;
        
        const wholeTiles = snappedTiles.filter(t => !isDecimalValue(t.value)).sort((a, b) => b.x - a.x);
        const decimalTiles = snappedTiles.filter(t => isDecimalValue(t.value)).sort((a, b) => a.x - b.x);
        
        for (let i = 0; i < wholeTiles.length - 1; i++) {
          const leftTile = wholeTiles[i + 1];
          const plusX = leftTile.x + getExpandedCardWidth(leftTile.value) * scale + 5;
          const plus = document.createElement('div');
          plus.className = 'plus-sign';
          plus.textContent = '+';
          plus.style.left = plusX + 'px';
          plus.style.top = plusY + 'px';
          plus.style.fontSize = (28 * scale) + 'px';
          workPane.appendChild(plus);
        }
        
        if (wholeTiles.length > 0 && decimalTiles.length > 0) {
          const plus = document.createElement('div');
          plus.className = 'plus-sign';
          plus.textContent = '+';
          plus.style.left = (decimalCenterX - 15) + 'px';
          plus.style.top = plusY + 'px';
          plus.style.fontSize = (28 * scale) + 'px';
          workPane.appendChild(plus);
        }
        
        for (let i = 0; i < decimalTiles.length - 1; i++) {
          const leftTile = decimalTiles[i];
          const plusX = leftTile.x + getExpandedCardWidth(leftTile.value) * scale + 5;
          const plus = document.createElement('div');
          plus.className = 'plus-sign';
          plus.textContent = '+';
          plus.style.left = plusX + 'px';
          plus.style.top = plusY + 'px';
          plus.style.fontSize = (28 * scale) + 'px';
          workPane.appendChild(plus);
        }
      }
      
      updateTotal(sum);
    }

    function updateTotal(val) {
      currentTotal = parseFloat(val.toFixed(4));
      document.getElementById('sumText').textContent = new Intl.NumberFormat('en-US').format(currentTotal);
      updateNumberLineTarget();
    }

    // ====== DRAG SYSTEM ======
    function startDrag(e, value, source) {
      e.preventDefault();
      e.stopPropagation();
      
      const rect = e.currentTarget.getBoundingClientRect();
      const placeValue = getPlaceValueType(value);
      const isDecimal = isDecimalValue(value);
      
      dragData = { value, placeValue, source, isDecimal };
      dragOffset = { x: e.clientX - rect.left, y: e.clientY - rect.top };
      
      dragGhost = createTileElement(value, isDecimal);
      dragGhost.classList.add('drag-ghost');
      document.body.appendChild(dragGhost);
      
      updateGhostPosition(e.clientX, e.clientY);
      isDragging = true;
      
      document.addEventListener('pointermove', onDragMove);
      document.addEventListener('pointerup', onDragEnd);
      document.addEventListener('pointercancel', onDragEnd);
    }
    
    function updateGhostPosition(clientX, clientY) {
      if (!dragGhost) return;
      dragGhost.style.left = (clientX - dragOffset.x) + 'px';
      dragGhost.style.top = (clientY - dragOffset.y) + 'px';
    }
    
    function onDragMove(e) {
      if (!isDragging) return;
      e.preventDefault();
      updateGhostPosition(e.clientX, e.clientY);
    }
    
    function onDragEnd(e) {
      if (!isDragging) return;
      
      document.removeEventListener('pointermove', onDragMove);
      document.removeEventListener('pointerup', onDragEnd);
      document.removeEventListener('pointercancel', onDragEnd);
      
      if (dragGhost) { dragGhost.remove(); dragGhost = null; }
      
      const workPane = document.getElementById('workPane');
      const paneRect = workPane.getBoundingClientRect();
      
      if (e.clientY >= paneRect.top && e.clientY <= paneRect.bottom) {
        const dropY = e.clientY - paneRect.top;
        const centerY = paneRect.height / 2;
        const snapZone = BLOCK_HEIGHT * 1.5;
        const touchingLine = Math.abs(dropY - centerY) < snapZone;
        
        const snapPos = getSnapLinePosition(dragData.placeValue);
        const order = getPlaceValueOrder(dragData.placeValue);
        const zIndex = 1000 + order;
        
        let finalX, finalY, snappedToLine;
        
        if (touchingLine) {
          finalX = snapPos.x; finalY = snapPos.y; snappedToLine = true;
          tiles = tiles.filter(t => {
            if (t.id === dragData.source) return true;
            return !(t.placeValue === dragData.placeValue && t.snappedToLine);
          });
        } else {
          finalX = e.clientX - paneRect.left - dragOffset.x;
          finalY = dropY - dragOffset.y;
          snappedToLine = false;
        }
        
        if (dragData.source === 'tray') {
          tiles.push({ id: Date.now() + Math.random(), value: dragData.value, placeValue: dragData.placeValue, x: finalX, y: finalY, snappedToLine, zIndex });
        } else {
          const existing = tiles.find(t => t.id === dragData.source);
          if (existing) { existing.x = finalX; existing.y = finalY; existing.snappedToLine = snappedToLine; existing.zIndex = zIndex; }
        }
      } else if (dragData.source !== 'tray') {
        tiles = tiles.filter(t => t.id !== dragData.source);
      }
      
      isDragging = false; dragData = null;
      renderWorkPane();
    }

    // ====== NUMBER INPUT ======
    const totalDisplay = document.getElementById('totalDisplay');
    const numberInputWrapper = document.getElementById('numberInputWrapper');
    const numberInput = document.getElementById('numberInput');
    const inputConfirm = document.getElementById('inputConfirm');
    const inputCancel = document.getElementById('inputCancel');
    const speakBtn = document.getElementById('speakBtn');
    
    function showNumberInput() {
      totalDisplay.classList.add('editing');
      numberInputWrapper.classList.add('active');
      numberInput.value = currentTotal > 0 ? currentTotal.toString() : '';
      numberInput.focus(); numberInput.select();
    }
    
    function hideNumberInput() {
      totalDisplay.classList.remove('editing');
      numberInputWrapper.classList.remove('active');
    }
    
    function parseAndCreateTiles(inputValue) {
      const num = parseFloat(inputValue);
      if (isNaN(num) || num < 0 || num >= 10000000) {
        showMessage('‚ö†Ô∏è', 'Please enter a number between 0 and 9,999,999.999');
        return;
      }
      
      tiles = tiles.filter(t => !t.snappedToLine);
      const str = num.toFixed(3);
      const [wholePart, decimalPart] = str.split('.');
      
      const placeValueMap = [
        { place: 'millions', divisor: 1000000 },
        { place: 'hundredThousands', divisor: 100000 },
        { place: 'tenThousands', divisor: 10000 },
        { place: 'thousands', divisor: 1000 },
        { place: 'hundreds', divisor: 100 },
        { place: 'tens', divisor: 10 },
        { place: 'ones', divisor: 1 }
      ];
      
      let remaining = parseInt(wholePart) || 0;
      placeValueMap.forEach(({ place, divisor }) => {
        const digit = Math.floor(remaining / divisor);
        if (digit > 0) {
          tiles.push({ id: Date.now() + Math.random(), value: digit * divisor, placeValue: place, x: 0, y: 0, snappedToLine: true, zIndex: 1000 + getPlaceValueOrder(place) });
        }
        remaining = remaining % divisor;
      });
      
      if (decimalPart) {
        [{ place: 'tenths', index: 0, multiplier: 0.1 }, { place: 'hundredths', index: 1, multiplier: 0.01 }, { place: 'thousandths', index: 2, multiplier: 0.001 }].forEach(({ place, index, multiplier }) => {
          const digit = parseInt(decimalPart[index]) || 0;
          if (digit > 0) {
            tiles.push({ id: Date.now() + Math.random(), value: parseFloat((digit * multiplier).toFixed(3)), placeValue: place, x: 0, y: 0, snappedToLine: true, zIndex: 1000 + getPlaceValueOrder(place) });
          }
        });
      }
      
      if (num >= 1000000) currentZoomIndex = 9;
      else if (num >= 100000) currentZoomIndex = 8;
      else if (num >= 10000) currentZoomIndex = 7;
      else if (num >= 1000) currentZoomIndex = 6;
      else if (num >= 100) currentZoomIndex = 5;
      else if (num >= 10) currentZoomIndex = 4;
      else if (num >= 1) currentZoomIndex = 3;
      else if (num >= 0.1) currentZoomIndex = 2;
      else if (num >= 0.01) currentZoomIndex = 1;
      else currentZoomIndex = 0;
      
      hideNumberInput();
      renderWorkPane();
      snapNumberLine();
    }
    
    totalDisplay.addEventListener('click', (e) => {
      if (e.target === speakBtn || speakBtn.contains(e.target)) return;
      showNumberInput();
    });
    inputConfirm.addEventListener('click', () => { parseAndCreateTiles(numberInput.value); });
    inputCancel.addEventListener('click', hideNumberInput);
    numberInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') parseAndCreateTiles(numberInput.value);
      else if (e.key === 'Escape') hideNumberInput();
    });

    // ====== EVENT LISTENERS ======
    speakBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const utterance = new SpeechSynthesisUtterance(currentTotal.toString());
      utterance.rate = 0.9;
      window.speechSynthesis.speak(utterance);
    });

    document.getElementById('expandBtn').addEventListener('click', () => {
      if (tiles.filter(t => t.snappedToLine).length === 0) return;
      isExpanded = !isExpanded;
      document.getElementById('expandBtn').innerHTML = isExpanded ? '<span class="btn-icon">üîó</span> Collapse' : '<span class="btn-icon">üí•</span> Expand';
      renderWorkPane();
    });
    
    // ====== MULTIPLY / DIVIDE BY 10 ======
    function showMessage(emoji, text) {
      const popup = document.getElementById('messagePopup');
      popup.querySelector('.emoji').textContent = emoji;
      popup.querySelector('.text').textContent = text;
      popup.classList.add('show');
      setTimeout(() => popup.classList.remove('show'), 2500);
    }
    
    function getNextPlaceValue(placeValue, direction) {
      const allPlaces = ['thousandths', 'hundredths', 'tenths', 'ones', 'tens', 'hundreds', 'thousands', 'tenThousands', 'hundredThousands', 'millions'];
      const idx = allPlaces.indexOf(placeValue);
      const newIdx = idx + direction;
      if (newIdx < 0 || newIdx >= allPlaces.length) return null;
      return allPlaces[newIdx];
    }
    
    function getValueForPlaceValue(digit, placeValue) {
      const multipliers = { 'thousandths': 0.001, 'hundredths': 0.01, 'tenths': 0.1, 'ones': 1, 'tens': 10, 'hundreds': 100, 'thousands': 1000, 'tenThousands': 10000, 'hundredThousands': 100000, 'millions': 1000000 };
      return digit * multipliers[placeValue];
    }
    
    function getDigitFromValue(value) {
      if (value < 1) {
        const str = value.toFixed(3);
        for (let c of str) { if (c !== '0' && c !== '.') return parseInt(c); }
      }
      return parseInt(String(Math.floor(value))[0]);
    }
    
    function multiplyByTen() {
      const snappedTiles = tiles.filter(t => t.snappedToLine);
      if (snappedTiles.length === 0) return;
      
      for (let tile of snappedTiles) {
        const newPlace = getNextPlaceValue(tile.placeValue, 1);
        if (!newPlace) {
          const newValue = currentTotal * 10;
          if (newValue >= 10000000) showMessage('üöÄ', `Whoa! That would be ${newValue.toLocaleString()} ‚Äî too big for our number line!`);
          else showMessage('üìà', `That would push past millions!`);
          return;
        }
      }
      
      const newPlaceValues = snappedTiles.map(t => getNextPlaceValue(t.placeValue, 1));
      if (new Set(newPlaceValues).size !== newPlaceValues.length) { showMessage('ü§î', `Some digits would stack up! Try a different number.`); return; }
      
      if (isExpanded) { isExpanded = false; document.getElementById('expandBtn').innerHTML = '<span class="btn-icon">üí•</span> Expand'; }
      animateTransform(1);
    }
    
    function divideByTen() {
      const snappedTiles = tiles.filter(t => t.snappedToLine);
      if (snappedTiles.length === 0) return;
      
      for (let tile of snappedTiles) {
        const newPlace = getNextPlaceValue(tile.placeValue, -1);
        if (!newPlace) { showMessage('üî¨', `The ${tile.placeValue} digit (${getDigitFromValue(tile.value)}) would become ten-thousandths ‚Äî smaller than we can show!`); return; }
      }
      
      const newPlaceValues = snappedTiles.map(t => getNextPlaceValue(t.placeValue, -1));
      if (new Set(newPlaceValues).size !== newPlaceValues.length) { showMessage('ü§î', `Some digits would stack up! Try a different number.`); return; }
      
      if (isExpanded) { isExpanded = false; document.getElementById('expandBtn').innerHTML = '<span class="btn-icon">üí•</span> Expand'; }
      animateTransform(-1);
    }
    
    function animateTransform(direction) {
      const snappedTiles = tiles.filter(t => t.snappedToLine);
      const workPane = document.getElementById('workPane');
      const tileElements = [...workPane.querySelectorAll('.work-pane-tile')];
      
      const animationData = snappedTiles.map((tile, idx) => {
        const digit = getDigitFromValue(tile.value);
        const newPlaceValue = getNextPlaceValue(tile.placeValue, direction);
        const newValue = getValueForPlaceValue(digit, newPlaceValue);
        const wasDecimal = isDecimalValue(tile.value);
        const willBeDecimal = isDecimalValue(newValue);
        const el = tileElements.find(e => Math.abs(parseFloat(e.style.left) - tile.x) < 5);
        return { tile, el, digit, newPlaceValue, newValue, wasDecimal, willBeDecimal, colorChange: wasDecimal !== willBeDecimal };
      });
      
      animationData.forEach(data => {
        data.tile.placeValue = data.newPlaceValue;
        data.tile.value = data.newValue;
        data.tile.zIndex = 1000 + getPlaceValueOrder(data.newPlaceValue);
      });
      
      snappedTiles.forEach(tile => { const newPos = getSnapLinePosition(tile.placeValue); tile.x = newPos.x; tile.y = newPos.y; });
      
      animationData.forEach(data => {
        if (!data.el) return;
        data.el.style.transition = 'left 0.5s ease-in-out, background 0.5s ease-in-out, border-color 0.5s ease-in-out';
        data.el.style.left = data.tile.x + 'px';
        if (data.colorChange) {
          if (data.willBeDecimal) {
            data.el.style.background = 'var(--decimal-bg)'; data.el.style.borderColor = 'var(--decimal-border)';
            data.el.querySelectorAll('.digit-block').forEach(d => { d.style.transition = 'color 0.5s ease-in-out'; d.style.color = 'var(--decimal-text)'; });
          } else {
            data.el.style.background = 'var(--whole-bg)'; data.el.style.borderColor = 'var(--whole-border)';
            data.el.querySelectorAll('.digit-block').forEach(d => { d.style.transition = 'color 0.5s ease-in-out'; d.style.color = 'var(--whole-text)'; });
          }
        }
      });
      
      const newTotal = snappedTiles.reduce((sum, t) => sum + t.value, 0);
      currentTotal = parseFloat(newTotal.toFixed(4));
      document.getElementById('sumText').textContent = new Intl.NumberFormat('en-US').format(currentTotal);
      
      setTimeout(() => {
        renderWorkPane();
        if (currentTotal >= 1000000) currentZoomIndex = 9;
        else if (currentTotal >= 100000) currentZoomIndex = 8;
        else if (currentTotal >= 10000) currentZoomIndex = 7;
        else if (currentTotal >= 1000) currentZoomIndex = 6;
        else if (currentTotal >= 100) currentZoomIndex = 5;
        else if (currentTotal >= 10) currentZoomIndex = 4;
        else if (currentTotal >= 1) currentZoomIndex = 3;
        else if (currentTotal >= 0.1) currentZoomIndex = 2;
        else if (currentTotal >= 0.01) currentZoomIndex = 1;
        else currentZoomIndex = 0;
        snapNumberLine();
      }, 550);
    }
    
    document.getElementById('multiplyBtn').addEventListener('click', multiplyByTen);
    document.getElementById('divideBtn').addEventListener('click', divideByTen);

    document.querySelectorAll('.drawer-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        activeDrawer = tab.dataset.drawer;
        document.querySelectorAll('.drawer-tab').forEach(t => {
          t.classList.toggle('active', t === tab);
          if(t === tab) t.scrollIntoView({behavior: 'smooth', inline: 'center'});
        });
        renderActiveDrawer();
      });
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      tiles = []; isExpanded = false;
      document.getElementById('expandBtn').innerHTML = '<span class="btn-icon">üí•</span> Expand';
      renderWorkPane();
    });

    // Start
    renderActiveDrawer();
    renderWorkPane();
    snapNumberLine();


    // ============================================
    // QUIZ MODE ‚Äî IEP GOAL: Identify place value 
    // of a specific digit in decimals to hundredths
    // ============================================
    
    const QUIZ_TOTAL = 10;
    
    // Place values the quiz uses (ones through hundredths per the IEP goal)
    const QUIZ_PLACES = [
      { name: 'Hundred Thousands', symbol: '100,000' },
      { name: 'Ten Thousands', symbol: '10,000' },
      { name: 'Thousands', symbol: '1,000' },
      { name: 'Hundreds', symbol: '100' },
      { name: 'Tens', symbol: '10' },
      { name: 'Ones', symbol: '1' }
    ];

    let quizState = {
      questions: [],
      current: 0,
      score: 0,
      log: [],
      active: false,
      digitCount: 3  // 3 = ones/tens/hundreds, up to 6 = hundred thousands
    };

    // The place names in order from LEFT (biggest) to RIGHT (smallest)
    const PLACE_ORDER = ['Hundred Thousands', 'Ten Thousands', 'Thousands', 'Hundreds', 'Tens', 'Ones'];

    function getActivePlaces(digitCount) {
      // last N entries from PLACE_ORDER
      return PLACE_ORDER.slice(PLACE_ORDER.length - digitCount);
    }

    // Generate a random number with the given digit count
    // Leading digit is 1-9, all others 0-9 (zeros allowed)
    function generateQuizNumber(digitCount) {
      digitCount = digitCount || quizState.digitCount;
      const digitArr = [];
      const places = getActivePlaces(digitCount);
      for (let i = 0; i < digitCount; i++) {
        const min = i === 0 ? 1 : 0;  // no leading zero
        digitArr.push(Math.floor(Math.random() * (9 - min + 1)) + min);
      }

      const numStr = digitArr.join('');
      const digits = digitArr.map((d, i) => ({
        char: String(d),
        place: places[i]
      }));

      return { numStr, digits, value: parseInt(numStr) };
    }

    function generateQuizQuestions() {
      const digitCount = quizState.digitCount;
      const questions = [];
      const places = getActivePlaces(digitCount);

      const placeQueue = [];
      while (placeQueue.length < QUIZ_TOTAL) {
        const batch = [...places];
        for (let i = batch.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [batch[i], batch[j]] = [batch[j], batch[i]];
        }
        placeQueue.push(...batch);
      }

      for (let i = 0; i < QUIZ_TOTAL; i++) {
        const num = generateQuizNumber(digitCount);
        const targetPlace = placeQueue[i];
        const digitIndex = num.digits.findIndex(d => d && d.place === targetPlace);
        questions.push({
          number: num,
          highlightIndex: digitIndex,
          correctAnswer: targetPlace,
          highlightedDigit: num.digits[digitIndex].char
        });
      }
      return questions;
    }

    function parseCustomNumber(input) {
      // Strip commas and spaces
      const cleaned = input.replace(/[,\s]/g, '');
      const num = parseInt(cleaned);
      if (isNaN(num) || num < 1 || num > 999999) return null;
      
      const str = String(num);
      const digitCount = str.length;
      const places = getActivePlaces(digitCount);
      const digits = str.split('').map((char, i) => ({
        char: char,
        place: places[i]
      }));
      
      return { numStr: str, digits, value: num, digitCount };
    }

    function startQuiz(customNumber) {
      // Read the active digit-count button
      const activeBtn = document.querySelector('.quiz-range-btn.active');
      const digitCount = activeBtn ? parseInt(activeBtn.dataset.digits) : 3;
      
      quizState = {
        questions: [],
        current: 0,
        score: 0,
        log: [],
        active: true,
        digitCount: digitCount,
        customNumber: customNumber || null,
        practiceMode: !!customNumber
      };
      
      document.getElementById('quizOverlay').classList.add('active');
      document.getElementById('quizSettings').style.display = 'flex';
      
      if (customNumber) {
        quizState.digitCount = customNumber.digitCount;
        renderPracticeMode(customNumber);
      } else {
        quizState.questions = generateQuizQuestions();
        renderQuizQuestion();
      }
    }
    
    // ====== PRACTICE MODE (custom number, tap to highlight) ======
    function renderPracticeMode(customNum) {
      const card = document.getElementById('quizCard');
      
      // Hide quiz-only UI
      document.getElementById('quizProgressFill').style.width = '0%';
      document.getElementById('quizQuestionNum').textContent = `Practice Mode`;
      document.getElementById('quizScoreDisplay').textContent = `${quizState.score} of ${quizState.log.length} correct`;
      
      const placeToSymbol = {};
      QUIZ_PLACES.forEach(p => { placeToSymbol[p.name] = p.symbol; });
      
      // Build tappable digit display
      const formatted = customNum.value.toLocaleString();
      const rawDigits = customNum.digits;
      
      let digitsHTML = '<div class="quiz-number-display">';
      let rawIdx = 0;
      for (let ci = 0; ci < formatted.length; ci++) {
        if (formatted[ci] === ',') {
          digitsHTML += `<div class="quiz-digit separator">,</div>`;
        } else {
          const d = rawDigits[rawIdx];
          const label = placeToSymbol[d.place] || '';
          digitsHTML += `<div class="quiz-digit tappable" data-idx="${rawIdx}"><span>${d.char}</span><span class="quiz-digit-label">${label}</span></div>`;
          rawIdx++;
        }
      }
      digitsHTML += '</div>';
      
      card.innerHTML = `
        <div class="quiz-tap-prompt">Tap a digit to find its value</div>
        ${digitsHTML}
        <div id="practiceChoicesZone"></div>
        <div class="quiz-feedback" id="quizFeedback"></div>
        <div id="quizExpandFeedback"></div>
        <div class="quiz-new-number-row">
          <input type="text" class="quiz-new-number-input" id="practiceNewInput" placeholder="New number" />
          <button class="quiz-new-number-btn" id="practiceNewBtn">Go</button>
        </div>
      `;
      
      // Wire tappable digits
      card.querySelectorAll('.quiz-digit.tappable').forEach(el => {
        el.addEventListener('click', () => {
          const idx = parseInt(el.dataset.idx);
          onPracticeDigitTap(customNum, idx);
        });
      });
      
      // Wire new number input
      document.getElementById('practiceNewBtn').addEventListener('click', () => {
        launchPracticeFromInput();
      });
      document.getElementById('practiceNewInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') launchPracticeFromInput();
      });
    }
    
    function launchPracticeFromInput() {
      const val = document.getElementById('practiceNewInput').value.trim();
      if (!val) return;
      const parsed = parseCustomNumber(val);
      if (!parsed) {
        const inp = document.getElementById('practiceNewInput');
        inp.style.borderColor = '#ef4444';
        setTimeout(() => { inp.style.borderColor = '#d1d5db'; }, 1500);
        return;
      }
      quizState.customNumber = parsed;
      quizState.digitCount = parsed.digitCount;
      renderPracticeMode(parsed);
    }
    
    function onPracticeDigitTap(customNum, digitIndex) {
      const card = document.getElementById('quizCard');
      const d = customNum.digits[digitIndex];
      const digit = parseInt(d.char);
      
      // Build a temporary question object for reuse with buildExpandedForm / handleQuizAnswer
      const currentQ = {
        number: customNum,
        highlightIndex: digitIndex,
        correctAnswer: d.place,
        highlightedDigit: d.char
      };
      // Store it so handleQuizAnswer can find it
      quizState.currentPracticeQ = currentQ;
      
      const placeToSymbol = {};
      QUIZ_PLACES.forEach(p => { placeToSymbol[p.name] = p.symbol; });
      
      // Highlight the tapped digit, unhighlight others
      card.querySelectorAll('.quiz-digit.tappable').forEach(el => {
        el.classList.remove('highlighted');
        el.style.pointerEvents = 'none'; // disable until answered
      });
      const tappedEl = card.querySelector(`.quiz-digit.tappable[data-idx="${digitIndex}"]`);
      if (tappedEl) tappedEl.classList.add('highlighted');
      
      // Clear previous feedback
      document.getElementById('quizFeedback').textContent = '';
      document.getElementById('quizFeedback').className = 'quiz-feedback';
      document.getElementById('quizExpandFeedback').innerHTML = '';
      
      // Build choices
      const placeMultipliers = {
        'Ones': 1, 'Tens': 10, 'Hundreds': 100,
        'Thousands': 1000, 'Ten Thousands': 10000, 'Hundred Thousands': 100000
      };
      const activePlaces = getActivePlaces(quizState.digitCount);
      let choicePlaces = [...activePlaces];
      const allPlaceNames = PLACE_ORDER;
      const highestActive = activePlaces[0];
      const higherIdx = allPlaceNames.indexOf(highestActive) - 1;
      if (higherIdx >= 0) {
        choicePlaces = [allPlaceNames[higherIdx], ...choicePlaces];
      }
      
      let finalChoices = choicePlaces.map(placeName => {
        const val = digit * placeMultipliers[placeName];
        return { name: placeName, symbol: val.toLocaleString() };
      });
      
      // Shuffle
      for (let i = finalChoices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [finalChoices[i], finalChoices[j]] = [finalChoices[j], finalChoices[i]];
      }
      
      const zone = document.getElementById('practiceChoicesZone');
      zone.innerHTML = `
        <button class="quiz-expand-btn" id="quizHintBtn">üí• Expand</button>
        <div id="quizExpandZone"></div>
        <div class="quiz-choices">
          ${finalChoices.map(c => `<button class="quiz-choice" data-answer="${c.name}">${c.symbol}</button>`).join('')}
        </div>
      `;
      
      // Wire hint
      document.getElementById('quizHintBtn').addEventListener('click', () => {
        document.getElementById('quizExpandZone').innerHTML = buildExpandedForm(currentQ);
        document.getElementById('quizHintBtn').style.display = 'none';
      });
      
      // Wire choices
      zone.querySelectorAll('.quiz-choice').forEach(btn => {
        btn.addEventListener('click', () => handlePracticeAnswer(btn, currentQ, customNum));
      });
    }
    
    function handlePracticeAnswer(btn, q, customNum) {
      const answer = btn.dataset.answer;
      const correct = answer === q.correctAnswer;
      const feedback = document.getElementById('quizFeedback');
      
      // Disable choice buttons
      document.querySelectorAll('#practiceChoicesZone .quiz-choice').forEach(b => {
        b.style.pointerEvents = 'none';
        if (b.dataset.answer === q.correctAnswer) b.classList.add('correct');
      });
      
      // Hide hint button
      const hintBtn = document.getElementById('quizHintBtn');
      if (hintBtn) hintBtn.style.display = 'none';
      
      if (correct) {
        quizState.score++;
        btn.classList.add('correct');
        const encouragements = ['Nice!', 'Got it!', 'Yes!', 'Correct!', 'Great job!', 'You know it!'];
        feedback.textContent = encouragements[Math.floor(Math.random() * encouragements.length)];
        feedback.className = 'quiz-feedback correct-fb';
      } else {
        btn.classList.add('wrong');
        const placeMultipliers = {
          'Ones': 1, 'Tens': 10, 'Hundreds': 100,
          'Thousands': 1000, 'Ten Thousands': 10000, 'Hundred Thousands': 100000
        };
        const correctValue = parseInt(q.highlightedDigit) * placeMultipliers[q.correctAnswer];
        feedback.textContent = `It's ${correctValue.toLocaleString()}`;
        feedback.className = 'quiz-feedback wrong-fb';
      }
      
      // Show expanded form
      document.getElementById('quizExpandFeedback').innerHTML = buildExpandedForm(q);
      
      // Log
      const hintUsed = !!document.getElementById('quizExpandZone').innerHTML;
      quizState.log.push({
        number: q.number.numStr,
        digit: q.highlightedDigit,
        correctAnswer: q.correctAnswer,
        studentAnswer: answer,
        correct,
        hintUsed
      });
      
      document.getElementById('quizScoreDisplay').textContent = `${quizState.score} of ${quizState.log.length} correct`;
      
      // Re-enable digit tapping after a moment so she can tap the next one
      setTimeout(() => {
        const card = document.getElementById('quizCard');
        card.querySelectorAll('.quiz-digit.tappable').forEach(el => {
          el.style.pointerEvents = '';
        });
      }, 600);
    }

    function closeQuiz(forceClose) {
      if (!forceClose && quizState.practiceMode && quizState.log.length > 0) {
        showQuizResults();
        return;
      }
      quizState.active = false;
      document.getElementById('quizOverlay').classList.remove('active');
    }

    function renderQuizQuestion() {
      const q = quizState.questions[quizState.current];
      const card = document.getElementById('quizCard');
      
      // Progress
      document.getElementById('quizProgressFill').style.width = ((quizState.current / QUIZ_TOTAL) * 100) + '%';
      document.getElementById('quizQuestionNum').textContent = `Question ${quizState.current + 1} of ${QUIZ_TOTAL}`;
      document.getElementById('quizScoreDisplay').textContent = `${quizState.score} correct`;

      // Build digit display
      let digitsHTML = '<div class="quiz-number-display">';
      // Build symbol map from QUIZ_PLACES
      const placeToSymbol = {};
      QUIZ_PLACES.forEach(p => { placeToSymbol[p.name] = p.symbol; });
      
      // Format number with commas for display
      const numVal = q.number.value;
      const formatted = numVal.toLocaleString();
      const rawDigits = q.number.digits;
      
      // We need to map formatted string (with commas) back to digit objects
      // Walk through the formatted string and the raw digits in parallel
      let rawIdx = 0;
      for (let ci = 0; ci < formatted.length; ci++) {
        if (formatted[ci] === ',') {
          digitsHTML += `<div class="quiz-digit separator">,</div>`;
        } else {
          const d = rawDigits[rawIdx];
          const hl = rawIdx === q.highlightIndex ? ' highlighted' : '';
          const label = placeToSymbol[d.place] || '';
          digitsHTML += `<div class="quiz-digit${hl}"><span>${d.char}</span><span class="quiz-digit-label">${label}</span></div>`;
          rawIdx++;
        }
      }
      digitsHTML += '</div>';

      // Build answer choices: show the highlighted digit's VALUE at each place
      // e.g. if highlighted digit is 2, choices are 2, 20, 200, 2,000 etc.
      const activePlaces = getActivePlaces(quizState.digitCount);
      const digit = parseInt(q.highlightedDigit);
      
      // Multipliers for each place name
      const placeMultipliers = {
        'Ones': 1, 'Tens': 10, 'Hundreds': 100,
        'Thousands': 1000, 'Ten Thousands': 10000, 'Hundred Thousands': 100000
      };
      
      // Build choices from active places + one distractor above
      let choicePlaces = [...activePlaces];
      const allPlaceNames = PLACE_ORDER;
      const highestActive = activePlaces[0];
      const higherIdx = allPlaceNames.indexOf(highestActive) - 1;
      if (higherIdx >= 0) {
        choicePlaces = [allPlaceNames[higherIdx], ...choicePlaces];
      }
      
      let finalChoices = choicePlaces.map(placeName => {
        const val = digit * placeMultipliers[placeName];
        return { name: placeName, symbol: val.toLocaleString() };
      });
      
      // Shuffle
      for (let i = finalChoices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [finalChoices[i], finalChoices[j]] = [finalChoices[j], finalChoices[i]];
      }

      let choicesHTML = '<div class="quiz-choices">';
      finalChoices.forEach(c => {
        choicesHTML += `<button class="quiz-choice" data-answer="${c.name}">${c.symbol}</button>`;
      });
      choicesHTML += '</div>';

      card.innerHTML = `
        <div class="quiz-prompt">What is the place value of the <span style="color:#f59e0b;font-weight:900">highlighted</span> digit?</div>
        ${digitsHTML}
        <button class="quiz-expand-btn" id="quizHintBtn">üí• Expand</button>
        <div id="quizExpandZone"></div>
        ${choicesHTML}
        <div class="quiz-feedback" id="quizFeedback"></div>
        <div id="quizExpandFeedback"></div>
      `;

      // Hint button: show expanded form before answering
      document.getElementById('quizHintBtn').addEventListener('click', () => {
        const zone = document.getElementById('quizExpandZone');
        zone.innerHTML = buildExpandedForm(q);
        document.getElementById('quizHintBtn').style.display = 'none';
      });

      // Attach choice handlers
      card.querySelectorAll('.quiz-choice').forEach(btn => {
        btn.addEventListener('click', () => handleQuizAnswer(btn));
      });
    }

    function buildExpandedForm(q) {
      const placeMultipliers = {
        'Ones': 1, 'Tens': 10, 'Hundreds': 100,
        'Thousands': 1000, 'Ten Thousands': 10000, 'Hundred Thousands': 100000
      };
      const parts = [];
      q.number.digits.forEach((d, i) => {
        const digit = parseInt(d.char);
        if (digit === 0) return; // skip zeros in expanded form
        const val = digit * placeMultipliers[d.place];
        parts.push({
          display: val.toLocaleString(),
          isAnswer: i === q.highlightIndex
        });
      });
      
      let html = '<div class="quiz-expanded-form">';
      parts.forEach((p, i) => {
        if (i > 0) html += '<span class="quiz-expanded-plus">+</span>';
        html += `<span class="quiz-expanded-part${p.isAnswer ? ' is-answer' : ''}">${p.display}</span>`;
      });
      html += '</div>';
      return html;
    }

    function handleQuizAnswer(btn) {
      const q = quizState.questions[quizState.current];
      const answer = btn.dataset.answer;
      const correct = answer === q.correctAnswer;
      const feedback = document.getElementById('quizFeedback');

      // Disable all buttons
      document.querySelectorAll('.quiz-choice').forEach(b => {
        b.style.pointerEvents = 'none';
        if (b.dataset.answer === q.correctAnswer) b.classList.add('correct');
      });

      // Hide hint button
      const hintBtn = document.getElementById('quizHintBtn');
      if (hintBtn) hintBtn.style.display = 'none';

      if (correct) {
        quizState.score++;
        btn.classList.add('correct');
        const encouragements = ['Nice!', 'Got it!', 'Yes!', 'Correct!', 'Great job!', 'You know it!'];
        feedback.textContent = encouragements[Math.floor(Math.random() * encouragements.length)];
        feedback.className = 'quiz-feedback correct-fb';
      } else {
        btn.classList.add('wrong');
        const placeMultipliers = {
          'Ones': 1, 'Tens': 10, 'Hundreds': 100,
          'Thousands': 1000, 'Ten Thousands': 10000, 'Hundred Thousands': 100000
        };
        const correctValue = parseInt(q.highlightedDigit) * placeMultipliers[q.correctAnswer];
        feedback.textContent = `It's ${correctValue.toLocaleString()}`;
        feedback.className = 'quiz-feedback wrong-fb';
      }

      // Always show expanded form after answering
      const expandZone = document.getElementById('quizExpandFeedback');
      expandZone.innerHTML = buildExpandedForm(q);

      // Log ‚Äî track if hint was used
      const hintUsed = !document.getElementById('quizExpandZone').innerHTML ? false : true;
      quizState.log.push({
        number: q.number.numStr,
        digit: q.highlightedDigit,
        correctAnswer: q.correctAnswer,
        studentAnswer: answer,
        correct,
        hintUsed
      });

      document.getElementById('quizScoreDisplay').textContent = `${quizState.score} correct`;

      // Show Next button ‚Äî she advances when ready
      const nextBtn = document.createElement('button');
      nextBtn.className = 'quiz-next-btn';
      nextBtn.textContent = quizState.current + 1 >= QUIZ_TOTAL ? 'See Results ‚ûú' : 'Next ‚ûú';
      document.getElementById('quizExpandFeedback').after(nextBtn);
      nextBtn.addEventListener('click', () => {
        quizState.current++;
        if (quizState.current >= QUIZ_TOTAL) {
          showQuizResults();
        } else {
          renderQuizQuestion();
        }
      });
    }

    function showQuizResults() {
      const total = quizState.practiceMode ? quizState.log.length : QUIZ_TOTAL;
      const pct = total > 0 ? Math.round((quizState.score / total) * 100) : 0;
      document.getElementById('quizProgressFill').style.width = '100%';
      document.getElementById('quizQuestionNum').textContent = 'Complete!';
      
      let emoji, message;
      if (pct >= 80) {
        emoji = 'üåü';
        message = `${pct}% ‚Äî You crushed it! You really know your place values!`;
      } else if (pct >= 60) {
        emoji = 'üí™';
        message = `${pct}% ‚Äî Nice work! Let's keep practicing to get even stronger.`;
      } else if (pct >= 40) {
        emoji = 'üìà';
        message = `${pct}% ‚Äî You're building your skills! Try again to see your growth.`;
      } else {
        emoji = 'üå±';
        message = `${pct}% ‚Äî Every try helps you grow! Let's practice some more.`;
      }

      const card = document.getElementById('quizCard');
      card.innerHTML = `
        <div class="quiz-results">
          <div class="quiz-results-emoji">${emoji}</div>
          <div class="quiz-results-score">${quizState.score} / ${total}</div>
          <div class="quiz-results-label">${pct}% Accuracy</div>
          <div class="quiz-results-message">${message}</div>
          <div class="quiz-results-btns">
            <button class="quiz-results-btn primary" id="quizRetryBtn">Try Again</button>
            <button class="quiz-results-btn secondary" id="quizDataBtn">View Data</button>
            <button class="quiz-results-btn secondary" id="quizDoneBtn">Done</button>
          </div>
        </div>
      `;

      document.getElementById('quizRetryBtn').addEventListener('click', () => {
        startQuiz(quizState.customNumber);
      });
      document.getElementById('quizDoneBtn').addEventListener('click', () => closeQuiz(true));
      document.getElementById('quizDataBtn').addEventListener('click', showQuizData);
    }

    function showQuizData() {
      const overlay = document.getElementById('quizDataOverlay');
      const card = document.getElementById('quizDataCard');
      const total = quizState.log.length;
      const pct = total > 0 ? Math.round((quizState.score / total) * 100) : 0;

      let rows = quizState.log.map((entry, i) => {
        const cls = entry.correct ? 'correct-row' : 'wrong-row';
        const icon = entry.correct ? '‚úì' : '‚úó';
        const hint = entry.hintUsed ? 'üí°' : '';
        return `<tr class="${cls}">
          <td>${i + 1}</td>
          <td>${entry.number}</td>
          <td>${entry.digit}</td>
          <td>${entry.correctAnswer}</td>
          <td>${entry.studentAnswer}</td>
          <td>${hint}</td>
          <td>${icon}</td>
        </tr>`;
      }).join('');

      const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

      card.innerHTML = `
        <h3>Quiz Data ‚Äî ${today}</h3>
        <p style="color:#94a3b8;font-size:13px;margin-bottom:12px;">Score: ${quizState.score}/${QUIZ_TOTAL} (${pct}%)</p>
        <table class="quiz-data-table">
          <thead><tr><th>#</th><th>Number</th><th>Digit</th><th>Correct</th><th>Response</th><th>Hint</th><th></th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
        <button class="quiz-data-copy" id="quizCopyBtn">Copy Data for IEP Log</button>
        <button class="quiz-data-close" id="quizDataCloseBtn">Close</button>
      `;

      overlay.classList.add('active');

      document.getElementById('quizDataCloseBtn').addEventListener('click', () => {
        overlay.classList.remove('active');
      });

      document.getElementById('quizCopyBtn').addEventListener('click', () => {
        let text = `Place Value Quiz ‚Äî ${today}\n`;
        text += `Score: ${quizState.score}/${QUIZ_TOTAL} (${pct}%)\n`;
        text += `Goal: Identify place value of a specific digit in whole numbers\n`;
        text += `Setting: ${quizState.digitCount}-digit numbers\n\n`;
        text += `#\tNumber\tDigit\tCorrect Answer\tStudent Answer\tHint Used\tResult\n`;
        quizState.log.forEach((entry, i) => {
          text += `${i+1}\t${entry.number}\t${entry.digit}\t${entry.correctAnswer}\t${entry.studentAnswer}\t${entry.hintUsed ? 'Yes' : 'No'}\t${entry.correct ? 'Correct' : 'Incorrect'}\n`;
        });
        
        // Error analysis
        const wrongOnes = quizState.log.filter(e => !e.correct);
        if (wrongOnes.length > 0) {
          text += `\nError Analysis:\n`;
          const errorsByPlace = {};
          wrongOnes.forEach(e => {
            if (!errorsByPlace[e.correctAnswer]) errorsByPlace[e.correctAnswer] = [];
            errorsByPlace[e.correctAnswer].push(e.studentAnswer);
          });
          for (const [place, answers] of Object.entries(errorsByPlace)) {
            text += `- ${place}: missed ${answers.length}x (answered: ${answers.join(', ')})\n`;
          }
        }

        navigator.clipboard.writeText(text).then(() => {
          const btn = document.getElementById('quizCopyBtn');
          btn.textContent = 'Copied!';
          btn.style.background = '#34d399';
          setTimeout(() => { btn.textContent = 'Copy Data for IEP Log'; btn.style.background = '#3b82f6'; }, 2000);
        });
      });
    }

    // Wire up quiz button
    document.getElementById('quizBtn').addEventListener('click', () => startQuiz());
    document.getElementById('quizCloseBtn').addEventListener('click', closeQuiz);
    
    // Wire up digit-count toggle buttons ‚Äî clear custom input when selecting a range
    document.querySelectorAll('.quiz-range-btn[data-digits]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.quiz-range-btn[data-digits]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('quizCustomInput').value = '';
        if (quizState.active && quizState.current === 0) {
          startQuiz();
        }
      });
    });
    
    // Wire up custom number input
    const quizCustomInput = document.getElementById('quizCustomInput');
    const quizCustomBtn = document.getElementById('quizCustomBtn');
    
    function launchCustomQuiz() {
      const val = quizCustomInput.value.trim();
      if (!val) return;
      const parsed = parseCustomNumber(val);
      if (!parsed) {
        quizCustomInput.style.borderColor = '#ef4444';
        setTimeout(() => { quizCustomInput.style.borderColor = '#d1d5db'; }, 1500);
        return;
      }
      // Deselect range buttons
      document.querySelectorAll('.quiz-range-btn[data-digits]').forEach(b => b.classList.remove('active'));
      startQuiz(parsed);
    }
    
    quizCustomBtn.addEventListener('click', launchCustomQuiz);
    quizCustomInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') launchCustomQuiz();
    });
    quizCustomInput.addEventListener('focus', () => {
      quizCustomInput.style.borderColor = 'var(--accent)';
    });
    quizCustomInput.addEventListener('blur', () => {
      quizCustomInput.style.borderColor = '#d1d5db';
    });

  </script>
</body>
</html>
